<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!-- 案件管理-進行中案件資訊 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員中心-方案管理</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/emp_sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/jack_ongoingCases.css}">
</head>

<body>
    <div class="headerPage"></div>


    <div style="width: 100%; display: flex; justify-content: center;">
        <div style="max-width: 1200px; display: flex;">
            <div class="empSidebarPage"></div>
            <!-- empsidebar -->
            <div style="width: 950PX; padding: 10px;">


                <div class="jack_container">
<!--                    <div class="jack_section">-->
                        <div class="jack_section_title" th:text="'案件編號: ' + ${empOngoingCase.estabCaseID}"></div>
                        <div class="jack_income" th:utext="'收入$' + ${empOngoingCase.planPricePerCase}"></div>
                        <table class="jack_case_info">

                            <ul class="jack_info_list">
                                <li><strong>收取日期:</strong> <span th:utext="${empOngoingCase.estabCaseDate}"></span></li>
                                <li><strong>收取區間:</strong> <span th:utext="${empOngoingCase.timeRange}"></span></li>
                                <li><strong>收取地址:</strong> <span th:utext="${empOngoingCase.cityCode + empOngoingCase.cityName + empOngoingCase.floor}"></span></li>
                                <li><strong>收取方式:</strong> <span th:utext="${empOngoingCase.wayName}"></span></li>
                                <li><strong>垃圾最大容量:</strong> <span th:utext="${empOngoingCase.liter + ' 公斤'}"></span></li>
                            </ul>

                            <div class="row">
                                <div class="col-10">
                                    <button class="jack_button_accept"
                                            th:attr="data-action='accept', data-id=${empOngoingCase.estabCaseID}"
                                            onclick="updateStatus('accept', this.getAttribute('data-id'))">接受訂單
                                    </button>
                                </div>
                                <div class="col-2">
                                    <button class="jack_button_reject"
                                            th:attr="data-action='reject', data-id=${empOngoingCase.estabCaseID}"
                                            onclick="showConfirmationDialog(this)">拒絕訂單
                                    </button>
                                </div>
                            </div>

                        </table>
<!--                    </div>-->
                </div>


<!--                <div class="jack_container">-->

<!--                </div>-->

                <div class="jack_container">
                    <div class="jack_section">
                        <div class="jack_section_title">執行狀況回覆</div>
                        <div class="jack_upload_container">

                            <!-- 圖片預覽 -->
                            <img id="jack-preview" class="jack_preview" alt="預覽圖片">

                        </div>
                    </div>

                    <div class="row">
                        <div class="col-10">

<!--                            <div class="inner" style="text-align: center;">-->
<!--                                <br>-->
<!--                                <input type="text" id="estab-case-id" class="form-control mb-2" placeholder="190001" aria-label="id">-->
<!--                                <div class="input-group mb-2">-->
<!--                                    <input type="file" class="form-control" id="myFile" aria-describedby="inputGroupFileAddon04" aria-label="Upload">-->
<!--                                    <button class="btn btn-outline-secondary" type="button" id="upload-btn">上傳照片</button>-->
<!--                                </div>-->
<!--                                <div id="kp" style="text-align: center;"></div>-->
<!--                                            <img alt="kp-1" id="kp" src=""/>-->
<!--                            </div>-->

<!--                            <label for="jack-upload" class="jack_button_accept">上傳照片</label>-->
<!--                            <input type="file" id="jack-upload" class="jack_upload_input" accept="image/*">-->

<!--                            <input type="file" id="jack-upload" class="jack_upload_input" aria-describedby="inputGroupFileAddon04" aria-label="Upload" accept="image/*">-->
<!--                            <button type="button" class="jack_button_accept" id="upload-btn">上傳照片</button>-->

                            <form action="/uploadImage" method="post" enctype="multipart/form-data">
                                <input type="file" name="file" accept="image/*">
                                <button type="submit">上傳</button>
                            </form>

                            <h1>Uploaded Image</h1>

                            <img th:src="@{'/showImage'}" alt="Uploaded Image" width="300">
                        </div>
                        <div class="col-2">
                            <button type="button" class="jack_button_return" data-toggle="modal" data-bs-target="#exampleModal2" onclick="SystemTime()">回報問題</button>
                            <!-- <button class="jack_button_reject" onclick="showReportIssuePopup()">回報問題</button> -->
                        </div>
                        <div class="col-12">
                            <button class="jack_button_accept">完成收取</button>
                        </div>
                    </div>

                </div>



            </div>

        </div>
    </div>

        <div class="modal fade " id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content ">

                    <div class="modal-header mb_modal_header">
                        <div class="mb_modal_header_h5">
                            <h5 class="modal-title mb_modal_title" id="estabCaseID" th:text="'回報問題 案件編號: ' + ${empOngoingCase.estabCaseID}"></h5>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body mb_modal_body">
                        <form>
                            <div class="mb-3 mb_modal_body_div" >
                                <div class="mb_modal_div">
                                    <!-- 方案及商品基本資料 -->
                                    <label for="recipient-name" class="col-form-label mb_modal_label" th:text="'收取日期: '+ ${empOngoingCase.estabCaseDate}"></label>
                                </div>
                                <div class="mb_modal_div">
                                    <label for="recipient-name" class="col-form-label mb_modal_label" th:text="'時段 : '+ ${empOngoingCase.timeRange}"></label>
                                </div>
                                <div class="mb_modal_div">
                                    <label for="recipient-name" class="col-form-label mb_modal_label" th:text="'收取員 : '+ ${empOngoingCase.empName}"></label>
                                </div>
                                <div class="mb_modal_div">
                                    <label for="recipient-name" class="col-form-label mb_modal_label" id="system-time"></label>
                                </div>

                                <div class="mb-3">
                                    <label for="recipient-name" class="col-form-label">聯絡電話 : </label>
                                    <input type="text" class="form-control" id="recipient-name">
                                </div>
                            </div>
                            <div class="mb-3 ">
                                <label for="message-text" class="col-form-label">內容</label>
                                <textarea class="form-control" id="message-text"></textarea>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer mb_estab_case_level_modal_footer">
                        <button type="button" class="btn btn-secondary mb_estab_case_complaint_cancel_btn" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary mb_estab_case_complaint_confirm_btn">送出</button>
                    </div>

                </div>
            </div>
        </div>




    <div class="footerPage"></div>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jack_ongoingCases.js}"></script>
<script>
    $("#upload-btn").click(()=>{
        const idVal = $('#estabCaseID').val()
        // if(!idVal){
        //     alert('請輸入 id ')
        //     return
        // }
        const files = $('#myFile').prop('files')
        if(!files[0]){
            alert('請上傳檔案')
            return
        }
        var formData = new FormData();
        formData.append('file', files[0]);
        $.ajax({
            url: `http://localhost:8080/estabcaseonging/${idVal}`,
            type: 'post',
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",
            success: (data) => {
                $("#kp").html(
                    `<div><h2>請投 1 號</h2></div>
                        <div><img alt="kp-1" src="data: image/jpeg;base64,${data.estabCasePic}"/></div>
                       `
                )
            },
            error: (jqXHR, exception) => {
                alert(jqXHR.responseJSON.message)
            }
        })
    })
    function showConfirmationDialog(button) {
        var estabCaseID = button.getAttribute('data-id');

        var isConfirmed = confirm("確定要拒絕訂單嗎？");

        if (isConfirmed) {
            updateStatus('reject', estabCaseID);
        } else {
            alert("已取消");
        }
    }
    function updateStatus(action, estabCaseID) {
        console.log("asdsa");
        var acceptButton = $('.jack_button_accept[data-action="accept"][data-id="' + estabCaseID + '"]');
        var rejectButton = $('.jack_button_reject[data-action="reject"][data-id="' + estabCaseID + '"]');

        $.ajax({
            type: 'POST',
            url: 'http://localhost:8080/estabcase/updateCaseStatus',
            data: {
                action: action,
                estabCaseID: estabCaseID
            },
            success: function(response) {
                console.log('Update successful');

                if (response) {
                    if (action === 'accept') {
                        acceptButton.text('已接單').prop('disabled', true);
                        rejectButton.prop('disabled', true);
                        console.log('Accept logic');
                    } else if (action === 'reject') {
                        rejectButton.text('已拒絕').prop('disabled', true);
                        acceptButton.prop('disabled', true);
                        console.log('Reject logic');
                        history.go(-1);
                    }
                } else {
                    console.log('Unexpected success response');
                }
            },
            error: function(error) {
                console.error('Update failed', error);
            }
        });
    }
    function SystemTime(){
        var currentTime = new Date();
        var hours = currentTime.getHours();
        var minutes = currentTime.getMinutes();
        var seconds = currentTime.getSeconds();

        hours = (hours < 10 ? "0" : "") + hours;
        minutes = (minutes < 10 ? "0" : "") + minutes;
        seconds = (seconds < 10 ? "0" : "") + seconds;

        var formattedTime = "現在時間 : " + hours + ":" + minutes + ":" + seconds;
        document.getElementById("system-time").innerText = formattedTime;
    }
</script>
</body>

</html>